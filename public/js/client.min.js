function loadImages(callback){var src,sources={tv:"tv.png",folder:"folder.png",folder_open:"folder_open.png",easy:"easy.jpg",hard:"hard.jpg"},loadedImages=0,numImages=0;for(src in sources)numImages++;for(src in sources)images[src]=new Image,images[src].onload=function(){++loadedImages>=numImages&&callback()},images[src].src="/img/"+sources[src]}function closeDir(canvasDir,type){var ctx=canvasDir.getContext("2d");ctx.save(),ctx.clearRect(0,0,canvasDir.width,canvasDir.height),ctx.drawImage(images.folder,0,0,canvasDir.width,canvasDir.height),ctx.textAlign="center",ctx.font="2em DejaVu Sans",ctx.shadowColor="#000",ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=5,ctx.fillStyle="#c72127",ctx.fillText(type,canvasDir.width/2,canvasDir.height/2),ctx.restore()}function openDir(canvasDir,type,callback){var ctx=canvasDir.getContext("2d");ctx.save(),ctx.clearRect(0,0,canvasDir.width,canvasDir.height),ctx.drawImage(images.folder_open,0,0,canvasDir.width,canvasDir.height),ctx.textAlign="center",ctx.font="2em DejaVu Sans",ctx.shadowColor="#000",ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=5,ctx.fillStyle="#c72127",ctx.fillText(type,canvasDir.width/2,canvasDir.height/2),ctx.restore(),callback()}function loadDir(type){var idDir=type.checksum(),canvasDir=document.getElementById(idDir),ctx=canvasDir.getContext("2d");ctx.save(),ctx.clearRect(0,0,canvasDir.width,canvasDir.height),ctx.drawImage(images.folder,0,0,canvasDir.width,canvasDir.height),ctx.textAlign="center",ctx.font="2em DejaVu Sans",ctx.shadowColor="#000",ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=5,ctx.fillStyle="#c72127",ctx.fillText(type,canvasDir.width/2,canvasDir.height/2),ctx.restore()}function enter(canvasTask){var task=JSON.parse($(canvasTask).text());if(task.state<=1){var ctx=canvasTask.getContext("2d"),index=0;anim=setInterval(function(){var max=printImage(ctx,canvasTask,task,index);index+=1,index>=max&&(index=0),ctx.drawImage(images.tv,0,0,canvasTask.width,canvasTask.height),printText(ctx,canvasTask,task)},100)}}function leave(canvasTask){var task=JSON.parse($(canvasTask).text());if(task.state<=1){clearInterval(anim);var ctx=canvasTask.getContext("2d");printImage(ctx,canvasTask,task,0),ctx.drawImage(images.tv,0,0,canvasTask.width,canvasTask.height),printText(ctx,canvasTask,task)}}function printImage(ctx,canvasTask,task,index){if("easy"===task.difficulty)var imgWidth=480,image=images.easy;else var imgWidth=480,image=images.hard;var max=image.width/imgWidth;return ctx.drawImage(image,index*imgWidth,0,imgWidth,images.easy.height,0,0,canvasTask.width,canvasTask.height),max}function printText(ctx,canvasTask,task){ctx.save(),ctx.textAlign="center";var fontsize=2;task.title.length>10&&(fontsize=28/task.title.length),ctx.font=fontsize+"em DejaVu Sans",ctx.shadowColor="#000",ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=5,ctx.fillStyle="#c72127",ctx.fillText(task.title,canvasTask.width/2,canvasTask.height/2-20),ctx.font="2em DejaVu Sans",ctx.fillText(task.score+" pts",canvasTask.width/2,canvasTask.height/2+20),ctx.restore()}function loadTask(task){var idTask=task.title.checksum(),canvasTask=document.getElementById("task-"+idTask),ctx=canvasTask.getContext("2d");ctx.clearRect(0,0,canvasTask.width,canvasTask.height),task.state>1?(ctx.fillStyle="#000",ctx.fillRect(0,0,canvasTask.width,canvasTask.height),ctx.beginPath(),ctx.fillStyle="#fff",ctx.arc(canvasTask.width/2,canvasTask.height/2,2,0,2*Math.PI,!1),ctx.fill(),ctx.stroke()):printImage(ctx,canvasTask,task,0),ctx.drawImage(images.tv,0,0,canvasTask.width,canvasTask.height),printText(ctx,canvasTask,task)}function validateTask(title,callback){var idTask=title.checksum(),canvasTask=document.getElementById("task-"+idTask),ctx=canvasTask.getContext("2d"),radius=2;ctx.save();var shutdown=setInterval(function(){if(ctx.arc(canvasTask.width/2,canvasTask.height/2,radius,0,2*Math.PI,!1),ctx.fillStyle="#fff",ctx.fill(),ctx.drawImage(images.tv,0,0,canvasTask.width,canvasTask.height),radius+=70,radius>canvasTask.width/2+50){clearInterval(shutdown);var shutdown2=setInterval(function(){ctx.fillStyle="#000",ctx.fillRect(0,0,canvasTask.width,canvasTask.height),ctx.beginPath(),ctx.fillStyle="#fff",ctx.arc(canvasTask.width/2,canvasTask.height/2,radius,0,2*Math.PI,!1),ctx.fill(),ctx.stroke(),ctx.drawImage(images.tv,0,0,canvasTask.width,canvasTask.height),radius-=70,0>radius&&(clearInterval(shutdown2),callback())},50)}},50);ctx.restore()}function clickTask(canvasTask,callback){callback()}function htmlEncode(value){return $("<div/>").text(value).html()}String.prototype.checksum=function(){var i,chr,len,hash=0;if(0===this.length)return hash;for(i=0,len=this.length;len>i;i++)chr=this.charCodeAt(i),hash=(hash<<5)-hash+chr,hash|=0;return hash.toString()},images={};var anim,blink_val=0,blink;$(document).ready(function(){$("#console").draggable({cursor:"crosshair",drag:function(event,ui){ui.position.top<$("#navbar").height()&&(ui.position.top=$("#navbar").height()),ui.position.left<0&&(ui.position.left=0)}}),$("#console").on("blink",function(){clearInterval(blink),blink=setInterval(function(){0===blink_val?($("#blinkCursor").css("background-color","#aaa"),$("#blinkCursor").css("color","#000"),blink_val=1):($("#blinkCursor").css("background-color","#000"),$("#blinkCursor").css("color","#aaa"),blink_val=0)},500)}),$("#console").trigger("blink")}),sock.on("message",function(data){if(2===data.submit)$(".new_line").last().teletype({animDelay:100,text:data.message},function(){$("#blinkCursor").remove(),$("#console").append($('<p class="new_line"></p>').text($("#team").text()+"@inso2k15$ ")),$(".new_line").last().append('<span id="blinkCursor">&nbsp;</span>'),$("#console").trigger("blink");var h=$("#console")[0].scrollHeight;$("#console").scrollTop(h)});else{$("#blinkCursor").remove(),$(".new_line").last().text($("#team").text()+"@inso2k15$ "+data.message),1===data.submit&&$("#console").append($('<p class="new_line"></p>').text($("#team").text()+"@inso2k15$ ")),$(".new_line").last().append('<span id="blinkCursor">&nbsp;</span>'),$("#console").trigger("blink");var h=$("#console")[0].scrollHeight;$("#console").scrollTop(h)}}),$.fn.teletype=function(opts,callback){clearInterval(blink),$("#blinkCursor").remove();var $this=this,defaults={animDelay:50},settings=$.extend(defaults,opts);$.each(settings.text.split(""),function(i,letter){setTimeout(function(){$this.html($this.html()+letter)},settings.animDelay*i)}),setTimeout(function(){setTimeout(function(){$(".new_line").last().append('<span id="blinkCursor">&nbsp;</span>'),$("#console").trigger("blink"),callback()},100)},settings.animDelay*settings.text.length)},sock.on("giveMessages",function(messages){$("#blinkCursor").remove(),messages.forEach(function(message){var date=new Date(message.timestamp),seconds=date.getSeconds(),minutes=date.getMinutes(),hours=date.getHours();$("#console").append($('<p class="new_line"></p>').text("<"+hours+":"+minutes+":"+seconds+"> "+message.content))}),$("#console").append($('<p class="new_line"></p>').text($("#team").text()+"@inso2k15$ ")),$(".new_line").last().append('<span id="blinkCursor">&nbsp;</span>'),$("#console").trigger("blink");var h=$("#console")[0].scrollHeight;$("#console").scrollTop(h)}),$(document).ready(function(){$("#console").append('<p class="new_line">$ </p>'),setTimeout(function(){$(".new_line").last().teletype({animDelay:50,text:"ssh "+$("#team").text()+"@inso2k15"},function(){$("#console").append($('<p class="new_line"></p>').text($("#team").text()+"@inso2k15's password:")),setTimeout(function(){$(".new_line").last().teletype({animDelay:100,text:"**********"},function(){$("#console").append('<p class="new_line">Welcome on Insomni\'hack communicator</p>'),setTimeout(function(){$("#console").append($('<p class="new_line"></p>').text($("#team").text()+"@inso2k15$ ")),$(".new_line").last().teletype({animDelay:100,text:"cat /var/log/messages"},function(){sock.emit("getMessages")})},1e3)})},1e3)})},1e3)}),loadImages(function(){$("#popup").draggable({cursor:"crosshair",handle:".popupTitleBar"}),$("#pad").draggable({cursor:"crosshair",handle:".titleBar",drag:function(event,ui){ui.position.top<$("#navbar").height()&&(ui.position.top=$("#navbar").height()),ui.position.left<0&&(ui.position.left=0)}}),$("#pad").resizable(),sock.on("giveScore",function(team){$("#team").text(team.name),$("#score").text(team.score)}),sock.emit("getTasks"),sock.on("giveTasks",function(tasks){$("#challenges").html("");var canvases=[],types=[];tasks.forEach(function(task){var canvas=$("<canvas></canvas>");canvas.text(JSON.stringify(task)),canvas.attr("id","task-"+task.title.checksum()),canvas.addClass("buttonTask"),canvas.addClass(""),canvases.push({canvas:canvas,task:task}),-1===types.indexOf(task.type)&&types.push(task.type)}),types.forEach(function(type){var canvasDir=$("<canvas></canvas>");canvasDir.text(type),canvasDir.attr("id",type.checksum()),canvasDir.addClass("buttonDir"),$("#challenges").append(canvasDir),loadDir(type);var directory=$("<div></div>");directory.addClass("directory"),directory.addClass("window"),directory.attr("id","div-"+type.checksum());var dirTitle=$("<div></div>");dirTitle.addClass("titleBar"),dirTitle.attr("id","title-"+type.checksum()),dirTitle.text(type);var imgClose=$("<img/>");imgClose.addClass("imgClose"),imgClose.attr("src","/img/close-window.png"),dirTitle.append(imgClose);var dirContent=$("<div></div>");dirContent.addClass("content"),dirContent.attr("id","content-"+type.checksum()),directory.append(dirTitle),directory.append(dirContent),$("body").append(directory),$("#div-"+type.checksum()).draggable({cursor:"crosshair",handle:"#title-"+type.checksum(),drag:function(event,ui){ui.position.top<$("#navbar").height()&&(ui.position.top=$("#navbar").height()),ui.position.left<0&&(ui.position.left=0)}}),$("#div-"+type.checksum()).resizable(),$("#div-"+type.checksum()).css("position","absolute"),$("#div-"+type.checksum()).css("display","none")}),canvases.forEach(function(canvas){$("#content-"+canvas.task.type.checksum()).append(canvas.canvas),loadTask(canvas.task)})}),$("body").on("click",".directory",function(){$(".directory").css("z-index","1"),$(this).css("z-index","2")}),$("body").on("click",".imgClose",function(){var directory=$(this).parent().parent(),id=directory.attr("id").substring(4);directory.css("display","none"),closeDir(document.getElementById(id),$(this).parent().text())}),$("body").on("mouseenter",".buttonTask",function(e){enter(e.target,function(){})}),$("body").on("mouseleave",".buttonTask",function(e){leave(e.target,function(){})}),$("body").on("click","canvas",function(e){"buttonDir"===$(e.target).attr("class")?openDir(e.target,$(e.target).text(),function(){var id=$(e.target).attr("id");$("#div-"+id).css("display","block"),$(".directory").css("z-index","1"),$("#div-"+id).css("z-index","2")}):clickTask(e.target,function(){var title=JSON.parse($(e.target).text()).title;sock.emit("getTask",title)})}),sock.on("giveTask",function(task){$("#flag").val(""),$("#description").html(task.description),$("#titlePopup").text(task.title),$("#informations").text("Author : "+task.author+" - Difficulty : "+task.difficulty),task.state>1?($("#flag").attr("disabled",!0),$("#flag").attr("type","text"),$("#flag").val("Solved"),$("#submitFlag").css("display","none")):($("#flag").attr("disabled",!1),$("#flag").attr("type","password"),$("#flag").val(""),$("#submitFlag").css("display","inline")),$("#popup").css("display","block"),$("#flag").focus()}),sock.on("updateTask",function(task){"block"===$("#popup").css("display")&&$("#titlePopup").text()===task.title&&sock.emit("getTask",task.title),$("#task-"+task.title.checksum()).text(JSON.stringify(task)),loadTask(task)}),sock.on("validation",function(infos){$("#team").text()===infos.team?validateTask(infos.title,function(){sock.emit("updateTask",infos.title)}):sock.emit("updateTask",infos.title),sock.emit("getScore")}),sock.on("nope",function(error){$("#error").text(error),$("#error").css("display","block"),setTimeout(function(){$("#error").css("display","none")},1e3)}),$("#submitFlag").click(function(){"none"===$("#error").css("display")&&(sock.emit("submitFlag",{title:$("#titlePopup").text(),flag:$("#flag").val()}),$("#flag").val(""))}),$("#cancel").click(function(){$("#flag").val(""),$("#popup").css("display","none")}),sock.on("updateTaskScores",function(tasks){tasks.forEach(function(task){"block"===$("#popup").css("display")&&$("#titlePopup").text()===task.title&&sock.emit("getTask",task.title),loadTask(task)})}),sock.on("newTeam",function(){console.log("new team"),sock.emit("updateTaskScores")}),sock.on("refresh",function(){location.reload()}),sock.on("error",function(error){alert(error+" please contact administrator")}),sock.on("log",function(error){console.log(error)})}),$(document).keypress(function(e){13==e.which&&$("#flag").is(":focus")&&$("#submitFlag").click()});